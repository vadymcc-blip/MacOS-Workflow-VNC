name: Mac in Docker (Linux Hack)

on: workflow_dispatch

jobs:
  hackintosh:
    runs-on: ubuntu-latest # –ë–µ—Ä–µ–º–æ Linux (–≤—ñ–Ω –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π —ñ –Ω–µ –±–∞–Ω–∏—Ç—å—Å—è)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Enable KVM (Acceleration)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Start Docker-OSX (Safe Mode)
        run: |
          docker run -d \
            -p 5999:5999 \
            -e "DISPLAY=${DISPLAY:-:0.0}" \
            -e "GENERATED_DEFAULTS=true" \
            -e "MASTER_PLIST_URL=https://raw.githubusercontent.com/sickcodes/osx-serial-generator/master/config-custom.plist" \
            --name mac_os \
            sickcodes/docker-osx:auto

      - name: Setup Ngrok
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok
          ngrok config add-authtoken $NGROK_TOKEN
          # –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç—É–Ω–µ–ª—å –Ω–∞ –ø–æ—Ä—Ç 5999 (VNC –∑ –î–æ–∫–µ—Ä–∞)
          ngrok tcp 5999 --log=stdout > ngrok.log &

      - name: Wait for macOS to Boot
        run: |
          echo "üöÄ macOS is booting inside Docker... This takes about 10-15 minutes!"
          echo "Don't panic if VNC connects to a black screen initially."
          sleep 10

      - name: Show Ngrok URL (CONNECT HERE)
        run: |
          echo "=========================================================="
          echo "WAIT 2 MINUTES, THEN CONNECT TO THE URL BELOW:"
          curl --silent http://127.0.0.1:4040/api/tunnels | jq '.tunnels[0].public_url'
          echo "=========================================================="
          echo "Password is usually empty, or try 'admin'"
          
      - name: Keep Alive (Let it run)
        run: |
          # –¢—Ä–∏–º–∞—î–º–æ —Å–µ—Å—ñ—é –∞–∫—Ç–∏–≤–Ω–æ—é 2 –≥–æ–¥–∏–Ω–∏
          sleep 7200
